DROP SCHEMA IF EXISTS INSTACART;
CREATE SCHEMA INSTACART;

-- create the user staging table 
DROP TABLE IF EXISTS INSTACART.STG_USER CASCADE;
CREATE TABLE INSTACART.STG_USER (
  	USER_KEY		BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
    USER_ID 		BIGINT,
    FIRST_NM 		CHARACTER VARYING(60),
    LAST_NM 		CHARACTER VARYING(60),
	ADDRESS			CHARACTER VARYING(100),
	PHONE			BIGINT, 
    CITY 			CHARACTER VARYING(30),
    STATE 			CHARACTER VARYING(2),
    TRACK_HASH		BIGINT, 
  	START_TS     	TIMESTAMP WITHOUT TIME ZONE 
                    	DEFAULT '1970-01-01 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
	END_TS       	TIMESTAMP WITHOUT TIME ZONE 
                    	DEFAULT '2999-12-31 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
	ACTIVE_IND  	SMALLINT DEFAULT 1,   
    CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
    CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
    UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
    UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY(USER_KEY, USER_ID);

-- create the departments staging table 
DROP TABLE IF EXISTS INSTACART.STG_DEPARTMENT CASCADE;
CREATE TABLE INSTACART.STG_DEPARTMENT ( 
DEPARTMENT_KEY  BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
DEPARTMENT_ID	INTEGER,
DEPARTMENT_DESC	CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (DEPARTMENT_KEY, DEPARTMENT_ID);

-- create the products staging table 
DROP TABLE IF EXISTS INSTACART.STG_PRODUCT CASCADE;
CREATE TABLE INSTACART.STG_PRODUCT ( 
PRODUCT_KEY 	BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
PRODUCT_ID 		BIGINT,
PRODUCT_DESC	CHARACTER VARYING(300), 
AISLE_ID		BIGINT,
DEPARTMENT_ID	BIGINT,
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (PRODUCT_KEY, PRODUCT_ID);

-- create the aisle staging table 
DROP TABLE IF EXISTS INSTACART.STG_AISLE ;
CREATE TABLE INSTACART.STG_AISLE ( 
AISLE_KEY     	BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
AISLE_ID		INTEGER,
AISLE_DESC	    CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (AISLE_KEY, AISLE_ID);

-- create the aisle staging table 
DROP TABLE IF EXISTS INSTACART.STG_ORDER ;
CREATE TABLE INSTACART.STG_ORDER (                                     
ORDER_KEY     				BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
ORDER_ID					BIGINT,                                               
USER_ID						BIGINT,
EVAL_SET					CHARACTER VARYING(10),
ORDER_NUM	          		INTEGER,                                               
ORDER_DOW					INTEGER,
ORDER_HR					INTEGER,
DAYS_SINCE_LAST_ORDER		INTEGER,
CREATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER'                                  
) DISTSTYLE KEY SORTKEY (ORDER_KEY, ORDER_ID);

-- create the order_products staging table
DROP TABLE IF EXISTS INSTACART.STG_ORDER_PRODUCTS ;
CREATE TABLE INSTACART.STG_ORDER_PRODUCTS (                                     
ORDER_PRODUCTS_KEY			BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
ORDER_ID					BIGINT,
PRODUCT_ID					BIGINT, 
ADD_TO_CART_ORDER			INT,
REORDERED					INT,
CREATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER'                                  
) DISTSTYLE KEY SORTKEY (ORDER_PRODUCTS_KEY, ORDER_ID);


-- create the numbers table to help load dim_date
DROP TABLE IF EXISTS INSTACART.NUMBERS ;
CREATE TABLE INSTACART.NUMBERS ( NUMBER INT PRIMARY KEY );

-- create the aisle dimension table 
DROP TABLE IF EXISTS INSTACART.DIM_AISLE ;
CREATE TABLE INSTACART.DIM_AISLE ( 
AISLE_KEY  		BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
AISLE_ID		INTEGER,
AISLE_DESC	    CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (AISLE_KEY, AISLE_ID);


-- create the department dimension table 
DROP TABLE IF EXISTS INSTACART.DIM_DEPARTMENT ;
CREATE TABLE INSTACART.DIM_DEPARTMENT ( 
DEPARTMENT_KEY  BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
DEPARTMENT_ID	INTEGER,
DEPARTMENT_DESC	CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (DEPARTMENT_KEY, DEPARTMENT_ID);

-- create the product dimension table 
DROP TABLE IF EXISTS INSTACART.DIM_PRODUCT ;
CREATE TABLE INSTACART.DIM_PRODUCT ( 
PRODUCT_KEY     BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
PRODUCT_ID		INTEGER,
PRODUCT_DESC	CHARACTER VARYING(300), 
AISLE_KEY		BIGINT, 
DEPARTMENT_KEY	BIGINT,   
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (PRODUCT_KEY, PRODUCT_ID);

-- create the order dimension table 
DROP TABLE IF EXISTS INSTACART.DIM_ORDER CASCADE;
CREATE TABLE INSTACART.DIM_ORDER (                                     
ORDER_KEY     				BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
ORDER_ID					BIGINT,                                               
USER_ID						BIGINT,
EVAL_SET					CHARACTER VARYING(10),
ORDER_NUM	          		INT,                                               
ORDER_DOW					INT,
ORDER_HR					INT,
--PRODUCT_ID					BIGINT,	   
--DAYS_SINCE_LAST_ORDER		INT,
--ADD_TO_CART_ORDER			INT,
--REORDERED					INT,  
CREATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER'                                  
) DISTSTYLE KEY SORTKEY (ORDER_KEY, ORDER_ID);


DROP TABLE IF EXISTS INSTACART.DIM_USER CASCADE;
CREATE TABLE INSTACART.DIM_USER (
	USER_KEY		BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
    USER_ID 		BIGINT,
    FIRST_NM 		CHARACTER VARYING(60) NULL,
    LAST_NM 		CHARACTER VARYING(60) NULL,
	ADDRESS			CHARACTER VARYING(100) NULL,
	PHONE			BIGINT NULL, 
    CITY 			CHARACTER VARYING(30) NULL,
    STATE 			CHARACTER VARYING(2) NULL,
    TRACK_HASH		BIGINT NULL,
  	START_TS     	TIMESTAMP WITHOUT TIME ZONE 
                    	DEFAULT '1970-01-01 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
	END_TS       	TIMESTAMP WITHOUT TIME ZONE 
                    	DEFAULT '2999-12-31 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
	ACTIVE_IND  	SMALLINT DEFAULT 1, 
    CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
    CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
    UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
    UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY(USER_KEY, USER_ID);

DROP TABLE IF EXISTS INSTACART.DIM_TIME;
CREATE TABLE INSTACART.DIM_TIME (
  	TIME_KEY		INT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
    TIME_HR 		INT,
    CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
    CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
    UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
    UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY(TIME_KEY, TIME_HR);


DROP TABLE IF EXISTS INSTACART.DIM_DATE;
CREATE TABLE INSTACART.DIM_DATE (
  DATE_KEY			INT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
  DAY_NUMBER        INT, 
  DAY_NAME          CHAR(9),
  DAY_IS_WEEKDAY    SMALLINT,
  CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
  CREATED_BY_ID		CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
  UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
  UPDATED_BY_ID		CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY (DATE_KEY);
--CREATE TABLE INSTACART.DIM_DATE (
--  DATE_KEY				BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
--  DATE_ID               INTEGER  , 
--  FULL_DATE             DATE     ,
--  YEAR_NUMBER           SMALLINT ,
--  YEAR_WEEK_NUMBER      SMALLINT ,
--  YEAR_DAY_NUMBER       SMALLINT ,
--  QTR_NUMBER            SMALLINT ,
--  MONTH_NUMBER          SMALLINT ,
--  MONTH_NAME            CHAR(9)  ,
--  MONTH_DAY_NUMBER      SMALLINT ,
--  WEEK_DAY_NUMBER       SMALLINT ,
--  DAY_NAME              CHAR(9)  ,
--  DAY_IS_WEEKDAY        SMALLINT ,
--  DAY_IS_LAST_OF_MONTH  SMALLINT 
--) DISTSTYLE KEY SORTKEY (DATE_KEY);


DROP TABLE IF EXISTS INSTACART.FACT_SALES;
CREATE TABLE INSTACART.FACT_SALES
(
USER_KEY			BIGINT, 
ORDER_KEY			BIGINT,
PRODUCT_KEY			BIGINT,  
DEPARTMENT_KEY		BIGINT, 
AISLE_KEY			BIGINT, 
DATE_KEY			INT, 
TIME_KEY			INT, 
AISLE_DESC			CHARACTER VARYING(30),
DAY_NAME			CHARACTER VARYING(10),
DEPARTMENT_DESC		CHARACTER VARYING(30),
PRODUCT_DESC		CHARACTER VARYING(300),
ADD_TO_CART_ORDER	INT, 
REORDERED			INT,
CREATED_DT     		TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID		CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     		TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID		CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
--DISTSTYLE KEY 
SORTKEY (USER_KEY,	ORDER_KEY, PRODUCT_KEY, DEPARTMENT_KEY, AISLE_KEY, DATE_KEY, TIME_KEY)