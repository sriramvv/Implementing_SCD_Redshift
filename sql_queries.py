import configparser

# CONFIG
config = configparser.ConfigParser()
config.read('dwh.cfg')

# DROP TABLES
staging_user_table_drop = "DROP TABLE IF EXISTS INSTACART.STG_USER CASCADE;"
staging_department_table_drop = "DROP TABLE IF EXISTS INSTACART.STG_DEPARTMENT ;"
staging_product_table_drop = "DROP TABLE IF EXISTS INSTACART.STG_PRODUCT ;"
staging_aisle_table_drop = "DROP TABLE IF EXISTS INSTACART.STG_AISLE;"
staging_order_table_drop = "DROP TABLE IF EXISTS INSTACART.STG_ORDER;"
staging_order_products_table_drop = "DROP TABLE IF EXISTS INSTACART.STG_ORDER_PRODUCTS;"

dim_user_table_drop = "DROP TABLE IF EXISTS INSTACART.DIM_USER CASCADE;"
dim_department_table_drop = "DROP TABLE IF EXISTS INSTACART.DIM_DEPARTMENT ;"
dim_product_table_drop = "DROP TABLE IF EXISTS INSTACART.DIM_PRODUCT ;"
dim_aisle_table_drop = "DROP TABLE IF EXISTS INSTACART.DIM_AISLE;"
dim_order_table_drop = "DROP TABLE IF EXISTS INSTACART.DIM_ORDER;"
dim_date_table_drop = "DROP TABLE IF EXISTS INSTACART.DIM_DATE;"
dim_time_table_drop = "DROP TABLE IF EXISTS INSTACART.DIM_TIME;"

# CREATE TABLES
staging_user_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.STG_USER(
USER_KEY		BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
USER_ID 		BIGINT,
FIRST_NM 		CHARACTER VARYING(60),
LAST_NM 		CHARACTER VARYING(60),
ADDRESS			CHARACTER VARYING(100),
PHONE			BIGINT, 
CITY 			CHARACTER VARYING(30),
STATE 			CHARACTER VARYING(2),
TRACK_HASH		BIGINT, 
START_TS     	TIMESTAMP WITHOUT TIME ZONE 
                DEFAULT '1970-01-01 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
END_TS       	TIMESTAMP WITHOUT TIME ZONE 
               	DEFAULT '2999-12-31 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
ACTIVE_IND  	SMALLINT DEFAULT 1,   
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY(USER_KEY, USER_ID);
""")

staging_department_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.STG_DEPARTMENT ( 
DEPARTMENT_KEY  BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
DEPARTMENT_ID	INTEGER,
DEPARTMENT_DESC	CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (DEPARTMENT_KEY, DEPARTMENT_ID);
""")

staging_product_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.STG_PRODUCT(
PRODUCT_KEY 	BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
PRODUCT_ID 		BIGINT,
PRODUCT_DESC	CHARACTER VARYING(300), 
AISLE_ID		BIGINT,
DEPARTMENT_ID	BIGINT,
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (PRODUCT_KEY, PRODUCT_ID);
""")

staging_aisle_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.STG_AISLE ( 
AISLE_KEY     	BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
AISLE_ID		INTEGER,
AISLE_DESC	    CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (AISLE_KEY, AISLE_ID);
""")

staging_order_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.STG_ORDER (                                     
ORDER_KEY     				BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
ORDER_ID					BIGINT,                                               
USER_ID						BIGINT,
EVAL_SET					CHARACTER VARYING(10),
ORDER_NUM	          		INTEGER,                                               
ORDER_DOW					INTEGER,
ORDER_HR					INTEGER,
DAYS_SINCE_LAST_ORDER		INTEGER,
CREATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER'                                  
) DISTSTYLE KEY SORTKEY (ORDER_KEY, ORDER_ID);
""")

staging_order_products_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.STG_ORDER_PRODUCTS (                                     
ORDER_PRODUCTS_KEY			BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
ORDER_ID					BIGINT,
PRODUCT_ID					BIGINT, 
ADD_TO_CART_ORDER			INT,
REORDERED					INT,
CREATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     				TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID				CHARACTER VARYING(10) DEFAULT 'INSTAUSER'                                  
) DISTSTYLE KEY SORTKEY (ORDER_PRODUCTS_KEY, ORDER_ID);
""")

dim_user_table_create = ("""
CREATE TABLE INSTACART.DIM_USER (
USER_KEY		BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
USER_ID 		BIGINT,
FIRST_NM 		CHARACTER VARYING(60) NULL,
LAST_NM 		CHARACTER VARYING(60) NULL,
ADDRESS			CHARACTER VARYING(100) NULL,
PHONE			BIGINT NULL, 
CITY 			CHARACTER VARYING(30) NULL,
STATE 			CHARACTER VARYING(2) NULL,
TRACK_HASH		BIGINT NULL,
START_TS     	TIMESTAMP WITHOUT TIME ZONE 
                    DEFAULT '1970-01-01 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
END_TS       	TIMESTAMP WITHOUT TIME ZONE 
                    DEFAULT '2999-12-31 00:00:00'::TIMESTAMP WITHOUT TIME ZONE, 
ACTIVE_IND  	SMALLINT DEFAULT 1, 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY(USER_KEY, USER_ID)
""")

dim_department_table_create = ("""
CREATE TABLE IF NOT INSTACART.DIM_DEPARTMENT ( 
DEPARTMENT_KEY  BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
DEPARTMENT_ID	INTEGER,
DEPARTMENT_DESC	CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
)
DISTSTYLE KEY 
SORTKEY (DEPARTMENT_KEY, DEPARTMENT_ID);
""")

dim_product_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.DIM_PRODUCT ( 
PRODUCT_KEY     BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
PRODUCT_ID		INTEGER,
PRODUCT_DESC	CHARACTER VARYING(300), 
AISLE_KEY		BIGINT, 
DEPARTMENT_KEY	BIGINT,   
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY (PRODUCT_KEY, PRODUCT_ID);
""")

dim_aisle_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.DIM_AISLE ( 
AISLE_KEY  		BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
AISLE_ID		INTEGER,
AISLE_DESC	    CHARACTER VARYING(30), 
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY (AISLE_KEY, AISLE_ID);
""")

dim_order_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.DIM_ORDER (                                     
ORDER_KEY     		BIGINT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY, 
ORDER_ID			BIGINT,                                               
USER_ID				BIGINT,
EVAL_SET			CHARACTER VARYING(10),
ORDER_NUM	        INT,                                               
ORDER_DOW			INT,
ORDER_HR			INT,
CREATED_DT     		TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	    CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     		TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID		CHARACTER VARYING(10) DEFAULT 'INSTAUSER'                                  
) DISTSTYLE KEY SORTKEY (ORDER_KEY, ORDER_ID);
""")

dim_date_table_create = ("""
CREATE TABLE IF NOT EXISTS INSTACART.DIM_DATE (
  DATE_KEY			INT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
  DAY_NUMBER        INT, 
  DAY_NAME          CHAR(9),
  DAY_IS_WEEKDAY    SMALLINT,
  CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
  CREATED_BY_ID		CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
  UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
  UPDATED_BY_ID		CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY (DATE_KEY);
""")

dim_time_table_create = ("""
CREATE TABLE INSTACART.DIM_TIME (
TIME_KEY		INT GENERATED BY DEFAULT AS IDENTITY(1, 1) DISTKEY,
TIME_HR 		INT,
CREATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
CREATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER',                                 
UPDATED_DT     	TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),                           
UPDATED_BY_ID	CHARACTER VARYING(10) DEFAULT 'INSTAUSER' 
) DISTSTYLE KEY SORTKEY(TIME_KEY, TIME_HR);
""")

# STAGING TABLES

staging_departments_copy = ("""COPY INSTACART.STG_DEPARTMENT (DEPARTMENT_ID, DEPARTMENT_DESC)
FROM 's3://instacartmarketbasketanalysis/departments.csv' 
iam_role 'arn:aws:iam::411840229458:role/myRedshiftRole' 
csv delimiter ','; """)

staging_products_copy = ("""COPY INSTACART.STG_PRODUCT (PRODUCT_ID, PRODUCT_DESC,AISLE_ID,DEPARTMENT_ID)
FROM 's3://instacartmarketbasketanalysis/products.csv'
iam_role 'arn:aws:iam::411840229458:role/myRedshiftRole'
csv delimiter ',' IGNOREHEADER 1 """);

staging_aisle_copy = ("""COPY INSTACART.STG_AISLE (AISLE_ID, AISLE_DESC)
FROM 's3://instacartmarketbasketanalysis/aisles.csv'
iam_role 'arn:aws:iam::411840229458:role/myRedshiftRole'
csv delimiter ','; """)

staging_order_copy = ("""COPY INSTACART.STG_ORDER (ORDER_ID, USER_ID, EVAL_SET,ORDER_NUM, ORDER_DOW, ORDER_HR, DAYS_SINCE_LAST_ORDER)
FROM 's3://instacartmarketbasketanalysis/orders.csv'
iam_role 'arn:aws:iam::411840229458:role/myRedshiftRole'
csv delimiter ',' ignoreheader 1; """)

staging_order_products_copy = ("""COPY INSTACART.STG_ORDER_PRODUCTS (ORDER_ID, PRODUCT_ID, ADD_TO_CART_ORDER,REORDERED)
FROM 's3://instacartmarketbasketanalysis/order_products_prior.csv'
iam_role 'arn:aws:iam::411840229458:role/myRedshiftRole'
csv delimiter ',' ignoreheader 1; """)

# FINAL TABLES

dim_time_insert = ("""
INSERT INTO INSTACART.DIM_TIME (TIME_HR)
SELECT  CAST(TO_CHAR(DATEADD(HOUR, NUMBER-1, CAST('2000-01-01' AS DATE)), 'HH24') AS INT) 
FROM INSTACART.NUMBERS
WHERE NUMBER IN (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24); """)

# dim_date_insert = ("""
# INSERT INTO time
# SELECT a.start_time,
# EXTRACT (HOUR FROM a.start_time), EXTRACT (DAY FROM a.start_time),
# EXTRACT (WEEK FROM a.start_time), EXTRACT (MONTH FROM a.start_time),
# EXTRACT (YEAR FROM a.start_time), EXTRACT (WEEKDAY FROM a.start_time) FROM
# (SELECT TIMESTAMP 'epoch' + start_time/1000 *INTERVAL '1 second' as start_time FROM songplays) a;
# """)

dim_product_insert = ("""
INSERT INTO INSTACART.DIM_PRODUCT (PRODUCT_ID, PRODUCT_DESC, AISLE_KEY, DEPARTMENT_KEY)
SELECT P.PRODUCT_ID, P.PRODUCT_DESC, A.AISLE_KEY, D.DEPARTMENT_KEY 
FROM INSTACART.STG_PRODUCT P, INSTACART.DIM_AISLE A, INSTACART.DIM_DEPARTMENT D
WHERE P.AISLE_ID = A.AISLE_ID AND P.DEPARTMENT_ID = D.DEPARTMENT_ID; """)

dim_order_insert = ("""
INSERT INTO INSTACART.DIM_ORDER ( PRODUCT_KEY,USER_KEY,ORDER_ID,USER_ID,EVAL_SET,ORDER_NUM,ORDER_DOW,
ORDER_HR,PRODUCT_ID,DAYS_SINCE_LAST_ORDER,	ADD_TO_CART_ORDER, REORDERED ) 
SELECT P.PRODUCT_KEY, U.USER_KEY, O.ORDER_ID, O.USER_ID, O.EVAL_SET, O.ORDER_NUM, O.ORDER_DOW, O.ORDER_HR, 
P.PRODUCT_ID, O.DAYS_SINCE_LAST_ORDER,  OP.ADD_TO_CART_ORDER, OP.REORDERED 
FROM INSTACART.STG_ORDER_PRODUCTS OP
INNER JOIN INSTACART.STG_ORDER O  ON OP.ORDER_ID = O.ORDER_ID
INNER JOIN INSTACART.DIM_PRODUCT P ON OP.PRODUCT_ID = P.PRODUCT_ID
INNER JOIN INSTACART.DIM_USER U ON O.USER_ID = U.USER_ID; """)

dim_user_insert = """ALTER TABLE INSTACART.DIM_USER APPEND FROM INSTACART.STG_USER FILLTARGET;"""

dim_aisle_insert = """ALTER TABLE INSTACART.DIM_AISLE APPEND FROM INSTACART.STG_AISLE;"""

dim_department_insert = """ALTER TABLE INSTACART.DIM_DEPARTMENT APPEND FROM INSTACART.STG_DEPARTMENT;"""

fact_sales_insert = ("""
INSERT INTO INSTACART.FACT_SALES(
  USER_KEY, ORDER_KEY, PRODUCT_KEY, DEPARTMENT_KEY, AISLE_KEY, DATE_KEY, TIME_KEY, AISLE_DESC,DAY_NAME, 
  DEPARTMENT_DESC, PRODUCT_DESC, ADD_TO_CART_ORDER, REORDERED)
SELECT U.USER_KEY, O.ORDER_KEY, P.PRODUCT_KEY, P.DEPARTMENT_KEY, P.AISLE_KEY, DT.DATE_KEY, T.TIME_KEY, A.AISLE_DESC, 
DT.DAY_NAME, D.DEPARTMENT_DESC, P.PRODUCT_DESC, OP.ADD_TO_CART_ORDER, OP.REORDERED   
FROM INSTACART.DIM_USER U, INSTACART.DIM_ORDER O, INSTACART.STG_ORDER_PRODUCTS OP , INSTACART.DIM_PRODUCT P, 
INSTACART.DIM_DATE DT, INSTACART.DIM_TIME T, INSTACART.DIM_AISLE A, INSTACART.DIM_DEPARTMENT D 
WHERE U.USER_ID = O.USER_ID 
AND O.ORDER_ID = OP.ORDER_ID
AND OP.PRODUCT_ID = P.PRODUCT_ID
AND O.ORDER_DOW = DT.DAY_NUMBER
AND O.ORDER_HR = T.TIME_HR
AND A.AISLE_KEY = P.AISLE_KEY
AND D.DEPARTMENT_KEY = P.DEPARTMENT_KEY;	
""")

# QUERY LISTS
create_table_queries = [staging_user_table_create, staging_department_table_create, staging_product_table_create,
                        staging_aisle_table_create, staging_order_table_create, staging_order_products_table_create,
                        dim_user_table_create, dim_department_table_create, dim_product_table_create,
                        dim_aisle_table_create, dim_order_table_create, dim_date_table_create, dim_time_table_create]
drop_table_queries = [staging_user_table_drop, staging_department_table_drop, staging_product_table_drop,
                      staging_aisle_table_drop, staging_order_table_drop, staging_order_products_table_drop,
                      dim_user_table_drop, dim_department_table_drop, dim_product_table_drop, dim_aisle_table_drop,
                      dim_order_table_drop, dim_date_table_drop, dim_time_table_drop]
copy_table_queries = [staging_departments_copy, staging_products_copy, staging_aisle_copy, staging_order_copy,
                      staging_order_products_copy]
insert_table_queries = [dim_time_insert, dim_user_insert, dim_aisle_insert, dim_department_insert,
                        dim_product_insert, dim_order_insert]
